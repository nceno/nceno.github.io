{"version":3,"file":"provider.js","sourceRoot":"","sources":["../src/provider.ts"],"names":[],"mappings":"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","sourcesContent":["import { Payload, Network } from \"./types\";\nimport { isMobile } from \"./utils\";\n\nconst sdkVersion = '1.2.0';\nconst postMessages = {\n    PT_RESPONSE: 'PT_RESPONSE',\n    PT_HANDLE_REQUEST: 'PT_HANDLE_REQUEST',\n    PT_AUTHENTICATED: 'PT_AUTHENTICATED',\n    PT_SHOW_IFRAME: 'PT_SHOW_IFRAME',\n    PT_HIDE_IFRAME: 'PT_HIDE_IFRAME',\n    PT_USER_DENIED: 'PT_USER_DENIED',\n}\n\nexport class PortisProvider {\n    portisClient = 'https://app.portis.io';\n    requests: { [id: string]: { payload: Payload, cb } } = {};\n    queue: { payload: Payload, cb }[] = [];\n    iframe: Promise<HTMLIFrameElement>;\n    authenticated = false;\n    account: string | null = null;\n    network: string | null = null;\n    isPortis = true;\n    referrerAppOptions;\n\n    constructor(opts: { apiKey: string, network?: Network }) {\n\n        if (!opts.apiKey) {\n            throw Error\n        }\n\n        this.referrerAppOptions = {\n            sdkVersion,\n            network: opts.network || 'mainnet',\n            appHost: location.host,\n            apiKey: opts.apiKey,\n        };\n        this.iframe = this.createIframe();\n        this.listen();\n    }\n\n    sendAsync(payload: Payload, cb) {\n        this.enqueue(payload, cb);\n    }\n\n    send(payload: Payload) {\n        let result;\n\n        switch (payload.method) {\n\n            case 'eth_accounts':\n                const account = this.account;\n                result = account ? [account] : [];\n                break;\n\n            case 'eth_coinbase':\n                result = this.account;\n                break;\n\n            case 'net_version':\n                result = this.network;\n                break;\n\n            case 'eth_uninstallFilter':\n                this.sendAsync(payload, (_) => _);\n                result = true;\n                break;\n\n            default:\n                throw new Error(`The Portis Web3 object does not support synchronous methods like ${payload.method} without a callback parameter.`);\n        }\n\n        return {\n            id: payload.id,\n            jsonrpc: payload.jsonrpc,\n            result: result,\n        }\n    }\n\n    isConnected() {\n        return true;\n    }\n\n    private createIframe(): Promise<HTMLIFrameElement> {\n        return new Promise((resolve, reject) => {\n            window.addEventListener('load', () => {\n                const iframe = document.createElement('iframe');\n                const iframeStyleProps = {\n                    'display': 'none',\n                    'position': 'fixed',\n                    'top': '10px',\n                    'right': '20px',\n                    'height': '525px',\n                    'width': '390px',\n                    'z-index': '2147483647',\n                    'box-shadow': '0 5px 40px rgba(0,0,0,.16)',\n                    'border-radius': '8px',\n                    'border': 'none',\n                    'animation': 'portis-entrance 250ms ease-in-out forwards',\n                    'opacity': '0',\n                };\n                const iframeMobileStyleProps = {\n                    'display': 'none',\n                    'position': 'fixed',\n                    'z-index': '2147483647',\n                    'width': '100%',\n                    'height': '100%',\n                    'top': '0',\n                    'left': '0',\n                    'right': '0',\n                    'border': 'none',\n                };\n                const style = document.createElement('style');\n                style.innerHTML = '@keyframes portis-entrance { 100% { opacity: 1; top: 20px; } }';\n\n                if (isMobile()) {\n                    Object.keys(iframeMobileStyleProps).forEach((prop: any) => iframe.style[prop] = (iframeMobileStyleProps as any)[prop]);\n                } else {\n                    Object.keys(iframeStyleProps).forEach((prop: any) => iframe.style[prop] = (iframeStyleProps as any)[prop]);\n                }\n\n                iframe.scrolling = 'no';\n                iframe.id = 'PT_IFRAME';\n                iframe.src = `${this.portisClient}/send/?p=${btoa(JSON.stringify(this.referrerAppOptions))}`;\n                document.body.appendChild(iframe);\n                document.head.appendChild(style);\n                resolve(iframe);\n            }, false);\n        });\n    }\n\n    private showIframe() {\n        this.iframe.then(iframe => {\n            iframe.style.display = 'block'\n\n            if (isMobile()) {\n                document.body.style.overflow = 'hidden';\n            }\n        });\n    }\n\n    private hideIframe() {\n        this.iframe.then(iframe => {\n            iframe.style.display = 'none';\n\n            if (isMobile()) {\n                document.body.style.overflow = 'inherit';\n            }\n        });\n    }\n\n    private enqueue(payload: Payload, cb) {\n        this.queue.push({ payload, cb });\n\n        if (this.authenticated) {\n            this.dequeue();\n        } else if (this.queue.length == 1) {\n            // show iframe in order to authenticate the user\n            this.showIframe();\n        }\n    }\n\n    private dequeue() {\n        if (this.queue.length == 0) {\n            return;\n        }\n\n        const item = this.queue.shift();\n\n        if (item) {\n            const payload = item.payload;\n            const cb = item.cb;\n            this.sendPostMessage(postMessages.PT_HANDLE_REQUEST, payload);\n            this.requests[payload.id] = { payload, cb };\n            this.dequeue();\n        }\n    }\n\n    private sendPostMessage(msgType: string, payload?: Object) {\n        this.iframe.then(iframe => {\n            if (iframe.contentWindow) {\n                iframe.contentWindow.postMessage({ msgType, payload }, '*');\n            }\n        });\n    }\n\n    private listen() {\n        window.addEventListener('message', (evt) => {\n            if (evt.origin === this.portisClient) {\n                switch (evt.data.msgType) {\n\n                    case postMessages.PT_AUTHENTICATED: {\n                        this.authenticated = true;\n                        this.dequeue();\n                        break;\n                    }\n\n                    case postMessages.PT_RESPONSE: {\n                        const id = evt.data.response.id;\n                        this.requests[id].cb(null, evt.data.response);\n\n                        if (this.requests[id].payload.method === 'eth_accounts' || this.requests[id].payload.method === 'eth_coinbase') {\n                            this.account = evt.data.response.result[0];\n                        }\n\n                        if (this.requests[id].payload.method === 'net_version') {\n                            this.network = evt.data.response.result;\n                        }\n\n                        this.dequeue();\n                        break;\n                    }\n\n                    case postMessages.PT_SHOW_IFRAME: {\n                        this.showIframe();\n                        break;\n                    }\n\n                    case postMessages.PT_HIDE_IFRAME: {\n                        this.hideIframe();\n                        break;\n                    }\n\n                    case postMessages.PT_USER_DENIED: {\n                        const id = evt.data.response ? evt.data.response.id : null;\n\n                        if (id) {\n                            this.requests[id].cb(new Error('User denied transaction signature.'));\n                        } else {\n                            this.queue.forEach(item => item.cb(new Error('User denied transaction signature.')));\n                        }\n\n                        this.dequeue();\n                        break;\n                    }\n                }\n            }\n        }, false);\n    }\n}\n"]}